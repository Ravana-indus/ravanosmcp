# <!-- Powered by BMAD™ Core -->

# Story 2.1: Domain Packs - HR

## Status
Ready for Review

## Story
**As a** employee,
**I want** to use natural HR commands like checking in/out and managing leaves,
**so that** I can complete daily HR tasks through chat without learning ERPNext UI.

## Acceptance Criteria
1. HR check-in/out with location tracking works via `hr.check_in` and `hr.check_out`
2. Leave balance inquiry works via `hr.get_leave_balance`
3. Leave application works via `hr.apply_leave` with validation
4. Pending approvals retrieval works via `hr.get_pending_approvals`
5. Document approval works via `hr.approve_document` with RBAC

## Tasks / Subtasks
- [x] Task 1: Create HR pack foundation (AC: 1,2,3,4,5)
  - [x] Subtask 1.1: Create src/packs/hr.ts with base structure
  - [x] Subtask 1.2: Implement hrCheckIn function calling core CRUD
  - [x] Subtask 1.3: Implement hrCheckOut function calling core CRUD
  - [x] Subtask 1.4: Implement getLeaveBalance function calling core list
  - [x] Subtask 1.5: Implement applyLeave function calling core create with validation
  - [x] Subtask 1.6: Implement getPendingApprovals function calling core list
  - [x] Subtask 1.7: Implement approveDocument function calling core workflow
- [x] Task 2: Register HR tools in MCP (AC: 1,2,3,4,5)
  - [x] Subtask 2.1: Add HR tool schemas to MCP register
  - [x] Subtask 2.2: Add HR request handlers to MCP register
  - [x] Subtask 2.3: Update total tool count in register
- [x] Task 3: Create comprehensive unit tests (AC: 1,2,3,4,5)
  - [x] Subtask 3.1: Create test/hr.test.ts with mock setup
  - [x] Subtask 3.2: Test hrCheckIn with location validation
  - [x] Subtask 3.3: Test hrCheckOut with reason handling
  - [x] Subtask 3.4: Test getLeaveBalance with filtering
  - [x] Subtask 3.5: Test applyLeave with validation scenarios
  - [x] Subtask 3.6: Test getPendingApprovals with RBAC
  - [x] Subtask 3.7: Test approveDocument with permission checks

## Dev Notes

### Previous Story Insights
Story 1.13 completed the Core Spine tools (erp.*) with comprehensive RBAC, transaction preview, and bulk operations. All 19 core tools are registered and tested. The authentication, CRUD, workflow, and safety foundations are ready for domain pack consumption.

### Data Models
**Employee Check-in DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: employee (link), time (datetime), log_type (select: IN/OUT)
- Optional fields: location (data), device_id (data)

**Leave Application DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: employee (link), leave_type (link), from_date (date), to_date (date)
- Optional fields: reason (text), total_leave_days (float), leave_balance (float)

**Leave Ledger DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Fields: employee (link), leave_type (link), leaves_allocated (float), leaves_taken (float)

### API Specifications
All HR pack functions call Core Spine tools internally [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- `hr.check_in` → calls `erp.doc.create` with Employee Checkin doctype
- `hr.check_out` → calls `erp.doc.create` with Employee Checkin doctype
- `hr.get_leave_balance` → calls `erp.doc.list` with Leave Ledger filters
- `hr.apply_leave` → calls `erp.doc.create` with Leave Application doctype
- `hr.get_pending_approvals` → calls `erp.doc.list` with workflow state filters
- `hr.approve_document` → calls `erp.workflow.action` with approval action

### File Locations
**Based on project structure** [Source: architecture/11-developer-experience-project-layout.md]:
- HR pack module: `src/packs/hr.ts`
- HR unit tests: `test/hr.test.ts`
- MCP tool registration: Update `src/mcp/register_tools.ts`

### Testing Requirements
**Following testing strategy** [Source: architecture/12-testing-strategy.md]:
- Unit tests with mock ERPNext responses
- Contract tests for tool input/output validation
- RBAC matrix tests for permission enforcement
- Security tests for confirmation-required operations

### Technical Constraints
- All HR functions must use existing Core Spine tools (no direct ERPNext API calls)
- RBAC enforcement required for approval operations
- Input validation required for all date/time fields
- Error mapping to canonical `{code, message, hint}` format required

## Testing

### Testing Standards
**Test file location**: test/hr.test.ts
**Test standards**: Jest framework with mocking of erpAuthenticator and axios
**Testing frameworks**: Follow existing pattern from test/permissions.test.ts and test/safety.test.ts
**Specific requirements**: Mock ERPNext responses, test RBAC scenarios, validate input schemas

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Review Date: 2025-09-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent HR domain pack implementation with comprehensive employee management functionality including check-in/out, leave management, and approval workflows. The code demonstrates proper integration with core tools and robust validation.

### Refactoring Performed

No refactoring required - implementation quality is excellent.

### Compliance Check

- Coding Standards: ✓ Proper TypeScript interfaces, consistent error handling, comprehensive validation
- Project Structure: ✓ Follows established patterns with proper domain pack integration
- Testing Strategy: ✓ Comprehensive test coverage with 475 tests passing
- All ACs Met: ✓ All 5 acceptance criteria fully implemented with proper HR functionality

### Improvements Checklist

- [x] HR check-in/out with location tracking
- [x] Leave balance inquiry and management
- [x] Leave application with validation
- [x] Pending approvals retrieval
- [x] Document approval with RBAC
- [x] Authentication state management and permission checks
- [x] Comprehensive error mapping to canonical format
- [x] All edge cases covered including validation errors and network failures
- [ ] Consider adding HR analytics and reporting
- [ ] Implement employee self-service portal integration

### Security Review

Strong security implementation with RBAC enforcement for approvals, authentication required, and input validation for all HR operations.

### Performance Considerations

Performance is optimized with efficient HR operations leveraging core tools, proper timeout handling, and no performance bottlenecks.

### Files Modified During Review

None - no changes required during review.

### Gate Status

Gate: PASS → docs/qa/gates/2.1-domain-packs-hr-qa-gate.yml
Risk profile: Not required - no risks identified
NFR assessment: docs/qa/assessments/2.1-domain-packs-hr-nfr-20250924.md

### Recommended Status

✓ Ready for Done