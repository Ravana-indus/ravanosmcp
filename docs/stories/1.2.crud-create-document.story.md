# <!-- Powered by BMAD™ Core -->

# Story 1.2: CRUD – Create Document

## Status
Ready for Review

## Story
**As a** user,
**I want** create a document in ERPNext,
**so that** I can add new records via chat.

## Acceptance Criteria
1. Valid doctype creates doc
2. Invalid → `{code: "INVALID_DOCTYPE"}`
3. Response includes document ID

## Tasks / Subtasks
- [x] Task 1: Implement erp.doc.create tool (AC: 1, 2, 3)
  - [x] Subtask 1.1: Create crud.ts in src/core/ directory
  - [x] Subtask 1.2: Implement create function with doctype, doc parameters
  - [x] Subtask 1.3: Add doctype validation logic
  - [x] Subtask 1.4: Return success response with document ID for valid doctype
  - [x] Subtask 1.5: Return INVALID_DOCTYPE error for invalid doctype
- [x] Task 2: Integrate with ERPNext REST API (AC: 1, 2, 3)
  - [x] Subtask 2.1: Create ERPNext client adapter for document creation
  - [x] Subtask 2.2: Handle API authentication and session management
  - [x] Subtask 2.3: Implement error mapping from ERPNext to canonical format
  - [x] Subtask 2.4: Add request/response logging with PII scrubbing
- [x] Task 3: Register doc.create tool in MCP (AC: 1, 2, 3)
  - [x] Subtask 3.1: Update src/mcp/register_tools.ts to include doc.create tool
  - [x] Subtask 3.2: Create JSON schemas for doc.create tool inputs/outputs
  - [x] Subtask 3.3: Test tool registration and schema validation
- [x] Task 4: Add unit tests (AC: 1, 2, 3)
  - [x] Subtask 4.1: Create test/crud.test.ts
  - [x] Subtask 4.2: Write tests for successful document creation
  - [x] Subtask 4.3: Write tests for invalid doctype scenarios
  - [x] Subtask 4.4: Write tests for document ID response validation

## Dev Notes
### Relevant Source Tree Information
- **Core Module Location**: src/core/crud.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Adapter Location**: src/adapters/erpnext_client.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Tool Registration**: src/mcp/register_tools.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Test Location**: test/crud.test.ts [Source: architecture/11-developer-experience-project-layout.md#12]

### Technical Implementation Details
- **Framework**: MCP SDK [Source: architecture/2-components-responsibilities.md#2.1]
- **Error Handling**: Use canonical error format `{code: "INVALID_DOCTYPE"}` [Source: architecture/4-error-model-result-envelope.md#Common codes]
- **Response Format**: Follow standard envelope with requestId, tool, ok, data, meta [Source: architecture/4-error-model-result-envelope.md#Envelope]
- **Transport**: HTTPS to ERPNext; TLS verification required [Source: architecture/5-security-rbac.md#Transport]

### Tool Specifications
- **erp.doc.create**: `{ doctype, doc } → { name }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]

### Security Considerations
- **PII Scrubbing**: Logs redact tokens, salaries, card data; configurable field allow/deny lists [Source: architecture/5-security-rbac.md#PII Scrubbing]
- **RBAC**: Evaluate via `erp.permissions.check` before mutating tools [Source: architecture/5-security-rbac.md#RBAC]

### Testing
- **Test Standards**: Follow testing strategy from architecture docs [Source: architecture/12-testing-strategy.md]
- **Test Types**: Unit tests for CRUD functions; integration tests against mock ERPNext responses
- **Test Coverage**: Cover success scenarios, error scenarios, and edge cases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug logs required - all tasks completed successfully

### Completion Notes List
- All acceptance criteria met: valid doctype creates doc, invalid returns INVALID_DOCTYPE, response includes document ID
- Complete CRUD implementation with proper ERPNext integration using existing auth client
- Comprehensive error handling for all scenarios (404, 403, validation errors, network errors)
- All 12 unit tests pass covering success/failure scenarios
- Code follows project standards with proper logging and PII redaction

### File List
- src/core/crud.ts - Core CRUD functionality for document creation
- src/mcp/register_tools.ts - Updated with doc.create tool registration
- src/index.ts - Updated to use registerAllTools function
- test/crud.test.ts - Comprehensive unit tests for CRUD operations

## QA Results

### Review Date: 2025-09-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent CRUD implementation with comprehensive document creation functionality. The code demonstrates strong error handling, proper validation, and seamless integration with the authentication system. Error mapping from ERPNext to canonical format is well-implemented.

### Refactoring Performed

No refactoring required - code quality is excellent with proper separation of concerns.

### Compliance Check

- Coding Standards: ✓ Proper TypeScript interfaces, consistent error handling, comprehensive validation
- Project Structure: ✓ Follows established patterns with proper module organization
- Testing Strategy: ✓ Comprehensive unit tests with 285 tests passing, covering all scenarios
- All ACs Met: ✓ All acceptance criteria fully implemented with document ID response

### Improvements Checklist

- [x] Document creation with proper validation and error handling
- [x] ERPNext API integration with authentication state management
- [x] Comprehensive error mapping from ERPNext to canonical format
- [x] PII scrubbing implemented in logging
- [x] All edge cases covered including network failures and validation errors
- [ ] Consider adding document creation templates for common doctypes
- [ ] Implement batch document creation for improved performance

### Security Review

Strong security implementation with proper authentication requirements, PII data scrubbing in logs, and validation to prevent injection attacks. Document creation follows least privilege principle.

### Performance Considerations

Performance is adequate with proper timeout handling. No bottlenecks identified in the document creation flow.

### Files Modified During Review

None - no changes required during review.

### Gate Status

Gate: PASS → docs/qa/gates/1.2-crud-create-document-qa-gate.yml
Risk profile: Not required - no risks identified
NFR assessment: docs/qa/assessments/1.2-crud-create-document-nfr-20250924.md

### Recommended Status

✓ Ready for Done
