# <!-- Powered by BMAD™ Core -->

# Story 2.3: Domain Packs - Purchase & Inventory

## Status
Ready for Review

## Story
**As a** procurement specialist or warehouse manager,
**I want** to use natural purchase and inventory commands,
**so that** I can manage procurement and stock levels through chat without complex ERPNext navigation.

## Acceptance Criteria
1. Purchase request creation works via `purchase.create_purchase_request` with priority handling
2. Purchase order creation works via `purchase.create_purchase_order` with supplier validation
3. Purchase order receipt works via `purchase.receive_purchase_order` with quantity validation
4. Stock level inquiry works via `inventory.get_stock_levels` with warehouse filtering
5. Low stock alerts work via `inventory.get_low_stock_items` with reorder threshold checking

## Tasks / Subtasks
- [x] Task 1: Create Purchase pack foundation (AC: 1,2,3)
  - [x] Subtask 1.1: Create src/packs/purchase.ts with base structure
  - [x] Subtask 1.2: Implement createPurchaseRequest function with priority validation
  - [x] Subtask 1.3: Implement createPurchaseOrder function with supplier validation
  - [x] Subtask 1.4: Implement receivePurchaseOrder function with quantity validation
- [x] Task 2: Create Inventory pack foundation (AC: 4,5)
  - [x] Subtask 2.1: Create src/packs/inventory.ts with base structure
  - [x] Subtask 2.2: Implement getStockLevels function with warehouse filtering
  - [x] Subtask 2.3: Implement getLowStockItems function with reorder threshold logic
- [x] Task 3: Register Purchase & Inventory tools in MCP (AC: 1,2,3,4,5)
  - [x] Subtask 3.1: Add Purchase tool schemas to MCP register
  - [x] Subtask 3.2: Add Inventory tool schemas to MCP register
  - [x] Subtask 3.3: Add Purchase & Inventory request handlers to MCP register
  - [x] Subtask 3.4: Update total tool count in register
- [x] Task 4: Create comprehensive unit tests (AC: 1,2,3,4,5)
  - [x] Subtask 4.1: Create test/purchase.test.ts with mock setup
  - [x] Subtask 4.2: Create test/inventory.test.ts with mock setup
  - [x] Subtask 4.3: Test purchase request with priority scenarios
  - [x] Subtask 4.4: Test purchase order with supplier validation
  - [x] Subtask 4.5: Test purchase receipt with quantity validation
  - [x] Subtask 4.6: Test stock levels with warehouse filtering
  - [x] Subtask 4.7: Test low stock alerts with threshold checking

## Dev Notes

### Previous Story Insights
Stories 1.13 (Core Spine) and 2.1-2.2 (HR & Sales domain packs) establish the foundation and pattern. Purchase & Inventory packs follow the same pattern with Core Spine tool consumption for procurement workflows.

### Data Models
**Purchase Request DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: company (link), transaction_date (date)
- Child table: items with item_code (link), qty (float), warehouse (link)
- Optional fields: priority (select), required_by (date)

**Purchase Order DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: supplier (link), company (link), transaction_date (date)
- Child table: items with item_code (link), qty (float), rate (currency)
- Optional fields: delivery_date (date), terms (text)

**Purchase Receipt DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: supplier (link), purchase_order (link)
- Child table: items with item_code (link), qty (float), received_qty (float)

**Stock Ledger Entry DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Fields: item_code (link), warehouse (link), actual_qty (float), qty_after_transaction (float)

**Item DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Fields: item_code (data), item_name (data), stock_uom (link)
- Stock fields: min_order_qty (float), reorder_level (float), reorder_qty (float)

### API Specifications
All Purchase & Inventory functions call Core Spine tools internally [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- `purchase.create_purchase_request` → calls `erp.doc.create` with Purchase Request doctype
- `purchase.create_purchase_order` → calls `erp.doc.create` with Purchase Order doctype
- `purchase.receive_purchase_order` → calls `erp.doc.create` with Purchase Receipt doctype
- `inventory.get_stock_levels` → calls `erp.doc.list` with Stock Ledger Entry filters
- `inventory.get_low_stock_items` → calls `erp.doc.list` with Item filters and stock comparison

### File Locations
**Based on project structure** [Source: architecture/11-developer-experience-project-layout.md]:
- Purchase pack module: `src/packs/purchase.ts`
- Inventory pack module: `src/packs/inventory.ts`
- Purchase unit tests: `test/purchase.test.ts`
- Inventory unit tests: `test/inventory.test.ts`
- MCP tool registration: Update `src/mcp/register_tools.ts`

### Testing Requirements
**Following testing strategy** [Source: architecture/12-testing-strategy.md]:
- Unit tests with mock ERPNext responses for purchase workflows
- Contract tests for purchase order and receipt quantity validation
- Stock calculation tests for inventory levels and reorder logic
- RBAC matrix tests for purchase approval permissions
- Input validation tests for supplier and item codes

### Technical Constraints
- All functions must use existing Core Spine tools (no direct ERPNext API calls)
- Quantity validation required (received_qty cannot exceed ordered_qty)
- Supplier validation required for purchase orders
- Stock calculation logic required for low stock determination
- Error mapping to canonical `{code, message, hint}` format required
- Date validation required for delivery and required_by dates

## Testing

### Testing Standards
**Test file location**: test/purchase.test.ts, test/inventory.test.ts
**Test standards**: Jest framework with mocking of erpAuthenticator and axios
**Testing frameworks**: Follow existing pattern from test/sales.test.ts and other domain packs
**Specific requirements**: Mock ERPNext responses for suppliers/items/stock data, test quantity validations, verify reorder threshold calculations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results