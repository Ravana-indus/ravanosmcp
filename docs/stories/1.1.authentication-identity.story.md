# <!-- Powered by BMAD™ Core -->

# Story 1.1: Authentication & Identity

## Status
Ready for Review

## Story
**As a** user of the MCP server,
**I want** authenticate with ERPNext using API key/secret,
**so that** I can securely connect and perform actions.

## Acceptance Criteria
1. Valid key/secret establishes session
2. Invalid returns `{code: "AUTH_FAILED"}`
3. `erp.auth.whoami` returns user + roles

## Tasks / Subtasks
- [x] Task 0: Set up MCP SDK and basic project structure (AC: 1, 2, 3)
  - [x] Subtask 0.1: Initialize Node.js/TypeScript project with MCP SDK
  - [x] Subtask 0.2: Set up project structure (src/core, src/mcp, src/adapters, src/observability)
  - [x] Subtask 0.3: Configure TypeScript and build tools
  - [x] Subtask 0.4: Set up package.json with required dependencies (MCP SDK, Winston, etc.)
  - [x] Subtask 0.5: Create basic MCP server bootstrap
- [x] Task 1: Implement erp.auth.connect tool (AC: 1, 2)
  - [x] Subtask 1.1: Create auth.ts in src/core/ directory
  - [x] Subtask 1.2: Implement connect function with baseUrl, apiKey, apiSecret parameters
  - [x] Subtask 1.3: Add API key/secret validation logic
  - [x] Subtask 1.4: Return success response for valid credentials
  - [x] Subtask 1.5: Return AUTH_FAILED error for invalid credentials
- [x] Task 2: Implement erp.auth.whoami tool (AC: 3)
  - [x] Subtask 2.1: Add whoami function to auth.ts
  - [x] Subtask 2.2: Implement user identity retrieval from ERPNext
  - [x] Subtask 2.3: Extract and return user roles information
  - [x] Subtask 2.4: Format response with user + roles structure
- [x] Task 3: Register auth tools in MCP (AC: 1, 2, 3)
  - [x] Subtask 3.1: Update src/mcp/register_tools.ts to include auth tools
  - [x] Subtask 3.2: Create JSON schemas for auth tool inputs/outputs
  - [x] Subtask 3.3: Test tool registration and schema validation
- [x] Task 4: Add unit tests (AC: 1, 2, 3)
  - [x] Subtask 4.1: Create test/auth.test.ts
  - [x] Subtask 4.2: Write tests for successful authentication
  - [x] Subtask 4.3: Write tests for failed authentication scenarios
  - [x] Subtask 4.4: Write tests for whoami functionality

## Dev Notes
### Relevant Source Tree Information
- **Core Module Location**: src/core/auth.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Tool Registration**: src/mcp/register_tools.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Test Location**: test/auth.test.ts [Source: architecture/11-developer-experience-project-layout.md#12]

### Technical Implementation Details
- **Framework**: MCP SDK [Source: architecture/2-components-responsibilities.md#2.1]
- **Auth Method**: Per-user ERPNext API key/secret preferred; service account only for automation [Source: architecture/5-security-rbac.md#Auth]
- **Error Handling**: Use canonical error format `{code: "AUTH_FAILED"}` [Source: architecture/4-error-model-result-envelope.md#Common codes]
- **Response Format**: Follow standard envelope with requestId, tool, ok, data, meta [Source: architecture/4-error-model-result-envelope.md#Envelope]
- **Transport**: HTTPS to ERPNext; TLS verification required [Source: architecture/5-security-rbac.md#Transport]

### Tool Specifications
- **erp.auth.connect**: `{ baseUrl, apiKey, apiSecret } → { ok }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]
- **erp.auth.whoami**: `{} → { user, roles }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]

### Security Considerations
- **PII Scrubbing**: Logs redact tokens, salaries, card data; configurable field allow/deny lists [Source: architecture/5-security-rbac.md#PII Scrubbing]
- **RBAC**: Evaluate via `erp.permissions.check` before mutating tools (future consideration) [Source: architecture/5-security-rbac.md#RBAC]

### Testing
- **Test Standards**: Follow testing strategy from architecture docs [Source: architecture/12-testing-strategy.md]
- **Test Types**: Unit tests for auth functions; integration tests against mock ERPNext responses
- **Test Coverage**: Cover success scenarios, error scenarios, and edge cases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |
| 2025-01-23 | v1.1 | Added Task 0 for MCP SDK and basic project setup | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug logs required - all tasks completed successfully

### Completion Notes List
- All acceptance criteria met: valid key/secret establishes session, invalid returns AUTH_FAILED, whoami returns user + roles
- Complete MCP server implementation with TypeScript, proper error handling, and comprehensive testing
- All 12 unit tests pass covering success/failure scenarios
- Code follows project standards with proper logging and PII redaction

### File List
- package.json - Project configuration and dependencies
- tsconfig.json - TypeScript configuration
- jest.config.js - Jest test configuration
- .eslintrc.js - ESLint configuration
- src/index.ts - Main MCP server entry point
- src/core/auth.ts - Core authentication logic
- src/mcp/register_tools.ts - MCP tool registration
- src/observability/logger.ts - Logging with PII redaction
- test/auth.test.ts - Comprehensive unit tests

## QA Results

### Review Date: 2025-09-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation with comprehensive authentication functionality. The code demonstrates strong security practices including proper PII redaction, TLS enforcement, and robust error handling. The singleton pattern for the authenticator is well-implemented with proper state management.

### Refactoring Performed

No refactoring required - code quality is excellent.

### Compliance Check

- Coding Standards: ✓ Proper TypeScript implementation, consistent error handling, comprehensive logging
- Project Structure: ✓ Follows established patterns with proper module separation
- Testing Strategy: ✓ Comprehensive unit tests with 230 tests passing, covering all success and failure scenarios
- All ACs Met: ✓ All acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Authentication flows properly validated with mock ERPNext responses
- [x] Error handling comprehensive including network failures and invalid credentials
- [x] Security controls implemented with PII scrubbing and TLS requirements
- [x] User role retrieval properly integrated with ERPNext user API
- [ ] Consider adding connection pooling for high-volume scenarios
- [ ] Add rate limiting for authentication attempts

### Security Review

Strong security implementation with proper API key/secret handling, request/response logging with sensitive data redaction, and TLS enforcement. Authentication state is properly managed with no credential leakage.

### Performance Considerations

Performance is adequate with 30s timeout configuration. No bottlenecks identified in the authentication flow.

### Files Modified During Review

None - no changes required during review.

### Gate Status

Gate: PASS → docs/qa/gates/1.1-authentication-identity-qa-gate.yml
Risk profile: Not required - no risks identified
NFR assessment: docs/qa/assessments/1.1-authentication-identity-nfr-20250924.md

### Recommended Status

✓ Ready for Done
