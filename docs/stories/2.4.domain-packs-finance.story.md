# <!-- Powered by BMAD™ Core -->

# Story 2.4: Domain Packs - Finance

## Status
Ready for Review

## Story
**As a** finance team member or accountant,
**I want** to use natural finance commands for invoicing and payments,
**so that** I can complete financial workflows through chat without complex ERPNext accounting forms.

## Acceptance Criteria
1. Sales invoice creation works via `finance.create_sales_invoice` with tax calculation
2. Payment recording works via `finance.record_payment` with invoice matching
3. Outstanding invoice retrieval works via `finance.get_outstanding_invoices` with customer filtering
4. Expense claim creation works via `finance.create_expense_claim` with validation
5. Payment status tracking works with proper financial controls and RBAC

## Tasks / Subtasks
- [x] Task 1: Create Finance pack foundation (AC: 1,2,3,4,5)
  - [x] Subtask 1.1: Create src/packs/finance.ts with base structure
  - [x] Subtask 1.2: Implement createSalesInvoice function with tax calculation
  - [x] Subtask 1.3: Implement recordPayment function with invoice matching
  - [x] Subtask 1.4: Implement getOutstandingInvoices function with customer filtering
  - [x] Subtask 1.5: Implement createExpenseClaim function with validation
- [x] Task 2: Register Finance tools in MCP (AC: 1,2,3,4,5)
  - [x] Subtask 2.1: Add Finance tool schemas to MCP register
  - [x] Subtask 2.2: Add Finance request handlers to MCP register
  - [x] Subtask 2.3: Update total tool count in register
- [x] Task 3: Create comprehensive unit tests (AC: 1,2,3,4,5)
  - [x] Subtask 3.1: Create test/finance.test.ts with mock setup
  - [x] Subtask 3.2: Test createSalesInvoice with tax calculation scenarios
  - [x] Subtask 3.3: Test recordPayment with invoice matching validation
  - [x] Subtask 3.4: Test getOutstandingInvoices with customer filtering
  - [x] Subtask 3.5: Test createExpenseClaim with validation scenarios
  - [x] Subtask 3.6: Test RBAC enforcement for financial operations

## Dev Notes

### Previous Story Insights
Stories 1.13 (Core Spine) and 2.1-2.3 (HR, Sales, Purchase & Inventory domain packs) establish the foundation and pattern. Finance pack follows the same pattern but requires extra validation for financial controls and audit requirements.

### Data Models
**Sales Invoice DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: customer (link), due_date (date), company (link)
- Child table: items with item_code (link), qty (float), rate (currency)
- Calculated fields: total (currency), grand_total (currency), outstanding_amount (currency)

**Payment Entry DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: payment_type (select), party_type (select), party (dynamic link)
- Required fields: paid_amount (currency), received_amount (currency)
- Child table: references with reference_doctype (select), reference_name (dynamic link), allocated_amount (currency)

**Expense Claim DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: employee (link), expense_approver (link)
- Child table: expenses with expense_date (date), expense_type (link), amount (currency)
- Calculated fields: total_claimed_amount (currency), total_sanctioned_amount (currency)

### API Specifications
All Finance pack functions call Core Spine tools internally [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- `finance.create_sales_invoice` → calls `erp.doc.create` with Sales Invoice doctype
- `finance.record_payment` → calls `erp.doc.create` with Payment Entry doctype
- `finance.get_outstanding_invoices` → calls `erp.doc.list` with Sales Invoice filters (outstanding_amount > 0)
- `finance.create_expense_claim` → calls `erp.doc.create` with Expense Claim doctype

### File Locations
**Based on project structure** [Source: architecture/11-developer-experience-project-layout.md]:
- Finance pack module: `src/packs/finance.ts`
- Finance unit tests: `test/finance.test.ts`
- MCP tool registration: Update `src/mcp/register_tools.ts`

### Testing Requirements
**Following testing strategy** [Source: architecture/12-testing-strategy.md]:
- Unit tests with mock ERPNext responses for financial documents
- Contract tests for payment allocation and tax calculation
- RBAC matrix tests for financial approval permissions (critical for finance operations)
- Security tests for confirmation-required financial operations
- Input validation tests for amounts, dates, and customer/employee codes

### Technical Constraints
- All Finance functions must use existing Core Spine tools (no direct ERPNext API calls)
- Financial amount validation required (positive amounts, currency precision)
- Payment allocation validation (allocated amount cannot exceed invoice outstanding)
- RBAC enforcement critical for financial operations (create, modify, cancel)
- Audit trail requirements for all financial transactions
- Error mapping to canonical `{code, message, hint}` format required
- Date validation required (due dates, expense dates)

### Security Considerations
**Financial operations require enhanced security** [Source: architecture/5-security-rbac.md]:
- Confirmation prompts required for payment recording and invoice creation
- RBAC validation must check specific financial permissions
- All financial operations must be logged with audit details
- Sensitive financial data must be redacted from logs

## Testing

### Testing Standards
**Test file location**: test/finance.test.ts
**Test standards**: Jest framework with mocking of erpAuthenticator and axios
**Testing frameworks**: Follow existing pattern from test/purchase.test.ts and other domain packs
**Specific requirements**: Mock ERPNext responses for financial documents, test amount calculations, verify RBAC enforcement for financial permissions, test audit logging

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results