# <!-- Powered by BMAD™ Core -->

# Story 1.12: Files & Comments

## Status
Ready for Review

## Story
**As a** user,
**I want** upload files and add comments,
**so that** I can enrich ERPNext records.

## Acceptance Criteria
1. Upload succeeds
2. Comment visible in ERPNext

## Tasks / Subtasks
- [ ] Task 1: Implement erp.file.upload tool (AC: 1)
  - [ ] Subtask 1.1: Create files_comments.ts in src/core/ directory
  - [ ] Subtask 1.2: Implement upload function with doctype, name, file_base64, filename parameters
  - [ ] Subtask 1.3: Add file validation and processing logic
  - [ ] Subtask 1.4: Return success response with file URL for valid uploads
  - [ ] Subtask 1.5: Handle error scenarios for invalid file operations
- [ ] Task 2: Implement erp.comment.add tool (AC: 2)
  - [ ] Subtask 2.1: Add comment function to src/core/files_comments.ts
  - [ ] Subtask 2.2: Implement comment function with doctype, name, comment parameters
  - [ ] Subtask 2.3: Add comment validation logic
  - [ ] Subtask 2.4: Return success response for valid comments
  - [ ] Subtask 2.5: Handle error scenarios for invalid comment operations
- [ ] Task 3: Integrate with ERPNext file API (AC: 1)
  - [ ] Subtask 3.1: Add file upload endpoint to erpnext_client.ts
  - [ ] Subtask 3.2: Handle file encoding and decoding operations
  - [ ] Subtask 3.3: Implement proper error mapping for file operations
  - [ ] Subtask 3.4: Add response logging with PII scrubbing
- [ ] Task 4: Integrate with ERPNext comment API (AC: 2)
  - [ ] Subtask 4.1: Add comment creation endpoint to erpnext_client.ts
  - [ ] Subtask 4.2: Handle comment formatting and validation
  - [ ] Subtask 4.3: Implement proper error mapping for comment operations
  - [ ] Subtask 4.4: Add response logging with PII scrubbing
- [ ] Task 5: Register file and comment tools in MCP (AC: 1, 2)
  - [ ] Subtask 5.1: Update src/mcp/register_tools.ts to include file and comment tools
  - [ ] Subtask 5.2: Create JSON schemas for tool inputs/outputs
  - [ ] Subtask 5.3: Test tool registration and schema validation
- [ ] Task 6: Add unit tests (AC: 1, 2)
  - [ ] Subtask 6.1: Create test/files_comments.test.ts
  - [ ] Subtask 6.2: Write tests for successful file uploads
  - [ ] Subtask 6.3: Write tests for successful comment additions
  - [ ] Subtask 6.4: Write tests for error handling and edge cases

## Dev Notes
### Relevant Source Tree Information
- **Core Module Location**: src/core/files_comments.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Adapter Location**: src/adapters/erpnext_client.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Tool Registration**: src/mcp/register_tools.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Test Location**: test/files_comments.test.ts [Source: architecture/11-developer-experience-project-layout.md#12]

### Technical Implementation Details
- **Framework**: MCP SDK [Source: architecture/2-components-responsibilities.md#2.1]
- **Response Format**: Follow standard envelope with requestId, tool, ok, data, meta [Source: architecture/4-error-model-result-envelope.md#Envelope]
- **Transport**: HTTPS to ERPNext; TLS verification required [Source: architecture/5-security-rbac.md#Transport]

### Tool Specifications
- **erp.file.upload**: `{ doctype, name, file_base64, filename } → { fileUrl }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]
- **erp.comment.add**: `{ doctype, name, comment } → { ok }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]

### Security Considerations
- **PII Scrubbing**: Logs redact tokens, salaries, card data; configurable field allow/deny lists [Source: architecture/5-security-rbac.md#PII Scrubbing]
- **RBAC**: Evaluate via `erp.permissions.check` before uploading files or adding comments [Source: architecture/5-security-rbac.md#RBAC]

### Testing
- **Test Standards**: Follow testing strategy from architecture docs [Source: architecture/12-testing-strategy.md]
- **Test Types**: Unit tests for file and comment functions; integration tests against mock ERPNext responses
- **Test Coverage**: Cover file upload scenarios, comment addition scenarios, and error handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
