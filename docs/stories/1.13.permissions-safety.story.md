# <!-- Powered by BMAD™ Core -->

# Story 1.13: Permissions & Safety

## Status
Ready for Review

## Story
**As a** user,
**I want** RBAC and safe transaction previews,
**so that** I don't break ERPNext unintentionally.

## Acceptance Criteria
1. Unauthorized → `{code: "PERMISSION_DENIED"}`
2. Preview validates
3. Bulk rollback works

## Tasks / Subtasks
- [ ] Task 1: Implement erp.permissions.check tool (AC: 1)
  - [ ] Subtask 1.1: Create permissions.ts in src/core/ directory
  - [ ] Subtask 1.2: Implement check function with doctype, action parameters
  - [ ] Subtask 1.3: Add RBAC evaluation logic against ERPNext permission matrix
  - [ ] Subtask 1.4: Return allowed: true for authorized actions
  - [ ] Subtask 1.5: Return PERMISSION_DENIED error for unauthorized actions
- [ ] Task 2: Implement erp.txn.preview tool (AC: 2)
  - [ ] Subtask 2.1: Create safety.ts in src/core/ directory
  - [ ] Subtask 2.2: Implement preview function with doctype, doc parameters
  - [ ] Subtask 2.3: Add transaction validation logic
  - [ ] Subtask 2.4: Return valid: true and empty issues for valid transactions
  - [ ] Subtask 2.5: Return validation issues for invalid transactions
- [ ] Task 3: Implement erp.bulk.run tool (AC: 3)
  - [ ] Subtask 3.1: Add bulk function to src/core/safety.ts
  - [ ] Subtask 3.2: Implement bulk function with operations[] parameters
  - [ ] Subtask 3.3: Add transaction rollback logic
  - [ ] Subtask 3.4: Return results and rollback status for bulk operations
  - [ ] Subtask 3.5: Handle partial failures and rollback scenarios
- [ ] Task 4: Integrate with ERPNext permissions API (AC: 1)
  - [ ] Subtask 4.1: Add permission checking endpoint to erpnext_client.ts
  - [ ] Subtask 4.2: Handle user role and permission matrix retrieval
  - [ ] Subtask 4.3: Implement proper permission evaluation logic
  - [ ] Subtask 4.4: Add response logging with PII scrubbing
- [ ] Task 5: Integrate with ERPNext transaction validation (AC: 2)
  - [ ] Subtask 5.1: Add transaction preview endpoint to erpnext_client.ts
  - [ ] Subtask 5.2: Handle document validation before execution
  - [ ] Subtask 5.3: Implement proper error mapping for validation issues
  - [ ] Subtask 5.4: Add response logging with PII scrubbing
- [ ] Task 6: Register permissions and safety tools in MCP (AC: 1, 2, 3)
  - [ ] Subtask 6.1: Update src/mcp/register_tools.ts to include permissions and safety tools
  - [ ] Subtask 6.2: Create JSON schemas for tool inputs/outputs
  - [ ] Subtask 6.3: Test tool registration and schema validation
- [ ] Task 7: Add unit tests (AC: 1, 2, 3)
  - [ ] Subtask 7.1: Create test/permissions.test.ts and test/safety.test.ts
  - [ ] Subtask 7.2: Write tests for permission checking functionality
  - [ ] Subtask 7.3: Write tests for transaction preview validation
  - [ ] Subtask 7.4: Write tests for bulk operations and rollback functionality

## Dev Notes
### Relevant Source Tree Information
- **Core Module Location**: src/core/permissions.ts, src/core/safety.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Adapter Location**: src/adapters/erpnext_client.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Tool Registration**: src/mcp/register_tools.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Test Location**: test/permissions.test.ts, test/safety.test.ts [Source: architecture/11-developer-experience-project-layout.md#12]

### Technical Implementation Details
- **Framework**: MCP SDK [Source: architecture/2-components-responsibilities.md#2.1]
- **Error Handling**: Use canonical error format `{code: "PERMISSION_DENIED"}` [Source: architecture/4-error-model-result-envelope.md#Common codes]
- **Response Format**: Follow standard envelope with requestId, tool, ok, data, meta [Source: architecture/4-error-model-result-envelope.md#Envelope]
- **Transport**: HTTPS to ERPNext; TLS verification required [Source: architecture/5-security-rbac.md#Transport]

### Tool Specifications
- **erp.permissions.check**: `{ doctype, action } → { allowed }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]
- **erp.txn.preview**: `{ doctype, doc } → { valid, issues[] }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]
- **erp.bulk.run**: `{ operations[] } → { results[], rolledBack? }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]

### Security Considerations
- **PII Scrubbing**: Logs redact tokens, salaries, card data; configurable field allow/deny lists [Source: architecture/5-security-rbac.md#PII Scrubbing]
- **RBAC**: Evaluate via `erp.permissions.check` before any mutating operations [Source: architecture/5-security-rbac.md#RBAC]
- **Sensitive Ops**: Require `confirm: true` flag for dangerous operations [Source: architecture/5-security-rbac.md#Sensitive Ops]

### Reliability Requirements
- **Bulk Operations**: Support rollback for failed bulk operations [Source: architecture/6-performance-caching-and-rate-limits.md#Reliability]

### Testing
- **Test Standards**: Follow testing strategy from architecture docs [Source: architecture/12-testing-strategy.md]
- **Test Types**: Unit tests for permission and safety functions; integration tests against mock ERPNext responses
- **Test Coverage**: Cover permission scenarios, validation scenarios, and rollback functionality

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
