# <!-- Powered by BMAD™ Core -->

# Story 1.11: Reports & Printing

## Status
Ready for Review

## Story
**As a** user,
**I want** run reports and generate PDFs,
**so that** I can fetch analytics and share docs.

## Acceptance Criteria
1. Valid reports run
2. Invalid → `{code: "REPORT_NOT_FOUND"}`
3. PDF ≤ 2s

## Tasks / Subtasks
- [ ] Task 1: Implement erp.report.run tool (AC: 1, 2)
  - [ ] Subtask 1.1: Create reports_print.ts in src/core/ directory
  - [ ] Subtask 1.2: Implement run function with report_name, filters? parameters
  - [ ] Subtask 1.3: Add report validation logic
  - [ ] Subtask 1.4: Return report data with columns and rows for valid reports
  - [ ] Subtask 1.5: Return REPORT_NOT_FOUND error for invalid reports
- [ ] Task 2: Implement erp.print.get_pdf tool (AC: 3)
  - [ ] Subtask 2.1: Add get_pdf function to src/core/reports_print.ts
  - [ ] Subtask 2.2: Implement get_pdf function with doctype, name, print_format? parameters
  - [ ] Subtask 2.3: Add PDF generation performance optimization
  - [ ] Subtask 2.4: Return PDF base64 for valid documents
  - [ ] Subtask 2.5: Handle performance requirements (≤ 2s)
- [ ] Task 3: Integrate with ERPNext reports API (AC: 1, 2)
  - [ ] Subtask 3.1: Add reports execution endpoint to erpnext_client.ts
  - [ ] Subtask 3.2: Handle report filter translation
  - [ ] Subtask 3.3: Implement proper error mapping for invalid reports
  - [ ] Subtask 3.4: Add response logging with PII scrubbing
- [ ] Task 4: Integrate with ERPNext printing API (AC: 3)
  - [ ] Subtask 4.1: Add PDF generation endpoint to erpnext_client.ts
  - [ ] Subtask 4.2: Handle print format selection
  - [ ] Subtask 4.3: Implement performance monitoring and optimization
  - [ ] Subtask 4.4: Add response logging with PII scrubbing
- [ ] Task 5: Register reports and printing tools in MCP (AC: 1, 2, 3)
  - [ ] Subtask 5.1: Update src/mcp/register_tools.ts to include reports and printing tools
  - [ ] Subtask 5.2: Create JSON schemas for tool inputs/outputs
  - [ ] Subtask 5.3: Test tool registration and schema validation
- [ ] Task 6: Add unit tests (AC: 1, 2, 3)
  - [ ] Subtask 6.1: Create test/reports_print.test.ts
  - [ ] Subtask 6.2: Write tests for successful report execution
  - [ ] Subtask 6.3: Write tests for invalid report scenarios
  - [ ] Subtask 6.4: Write tests for PDF generation performance

## Dev Notes
### Relevant Source Tree Information
- **Core Module Location**: src/core/reports_print.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Adapter Location**: src/adapters/erpnext_client.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Tool Registration**: src/mcp/register_tools.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Test Location**: test/reports_print.test.ts [Source: architecture/11-developer-experience-project-layout.md#12]

### Technical Implementation Details
- **Framework**: MCP SDK [Source: architecture/2-components-responsibilities.md#2.1]
- **Error Handling**: Use canonical error format `{code: "REPORT_NOT_FOUND"}` [Source: architecture/4-error-model-result-envelope.md#Common codes]
- **Response Format**: Follow standard envelope with requestId, tool, ok, data, meta [Source: architecture/4-error-model-result-envelope.md#Envelope]
- **Transport**: HTTPS to ERPNext; TLS verification required [Source: architecture/5-security-rbac.md#Transport]

### Tool Specifications
- **erp.report.run**: `{ report_name, filters? } → { columns[], rows[] }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]
- **erp.print.get_pdf**: `{ doctype, name, print_format? } → { pdf_base64 }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]

### Security Considerations
- **PII Scrubbing**: Logs redact tokens, salaries, card data; configurable field allow/deny lists [Source: architecture/5-security-rbac.md#PII Scrubbing]
- **RBAC**: Evaluate via `erp.permissions.check` before accessing reports [Source: architecture/5-security-rbac.md#RBAC]

### Performance Requirements
- **PDF Generation**: P95 response latency < 2s for PDF generation [Source: architecture/6-performance-caching-and-rate-limits.md#Budget]

### Testing
- **Test Standards**: Follow testing strategy from architecture docs [Source: architecture/12-testing-strategy.md]
- **Test Types**: Unit tests for reports and printing functions; integration tests against mock ERPNext responses
- **Test Coverage**: Cover success scenarios, error scenarios, and performance requirements

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
