# <!-- Powered by BMAD™ Core -->

# Story 1.4: CRUD – List Documents

## Status
Ready for Review

## Story
**As a** user,
**I want** list documents with filters,
**so that** I can browse ERPNext records.

## Acceptance Criteria
1. Supports filters + limit
2. Empty result → `[]`

## Tasks / Subtasks
- [x] Task 1: Implement erp.doc.list tool (AC: 1, 2)
  - [x] Subtask 1.1: Add list function to src/core/crud.ts
  - [x] Subtask 1.2: Implement list function with doctype, filters?, fields?, limit? parameters
  - [x] Subtask 1.3: Add filter parsing and validation logic
  - [x] Subtask 1.4: Return filtered documents with limit applied
  - [x] Subtask 1.5: Return empty array for no matching documents
- [x] Task 2: Enhance ERPNext REST API integration (AC: 1, 2)
  - [x] Subtask 2.1: Add document listing endpoint to erpnext_client.ts
  - [x] Subtask 2.2: Handle filter translation to ERPNext query parameters
  - [x] Subtask 2.3: Implement pagination with limit parameter
  - [x] Subtask 2.4: Add response logging with PII scrubbing
- [x] Task 3: Register doc.list tool in MCP (AC: 1, 2)
  - [x] Subtask 3.1: Update src/mcp/register_tools.ts to include doc.list tool
  - [x] Subtask 3.2: Create JSON schemas for doc.list tool inputs/outputs
  - [x] Subtask 3.3: Test tool registration and schema validation
- [x] Task 4: Add unit tests (AC: 1, 2)
  - [x] Subtask 4.1: Add tests to test/crud.test.ts
  - [x] Subtask 4.2: Write tests for successful document listing
  - [x] Subtask 4.3: Write tests for filter functionality
  - [x] Subtask 4.4: Write tests for empty result scenarios

## Dev Notes
### Relevant Source Tree Information
- **Core Module Location**: src/core/crud.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Adapter Location**: src/adapters/erpnext_client.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Tool Registration**: src/mcp/register_tools.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Test Location**: test/crud.test.ts [Source: architecture/11-developer-experience-project-layout.md#12]

### Technical Implementation Details
- **Framework**: MCP SDK [Source: architecture/2-components-responsibilities.md#2.1]
- **Response Format**: Follow standard envelope with requestId, tool, ok, data, meta [Source: architecture/4-error-model-result-envelope.md#Envelope]
- **Transport**: HTTPS to ERPNext; TLS verification required [Source: architecture/5-security-rbac.md#Transport]

### Tool Specifications
- **erp.doc.list**: `{ doctype, filters?, fields?, limit? } → { docs }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]

### Security Considerations
- **PII Scrubbing**: Logs redact tokens, salaries, card data; configurable field allow/deny lists [Source: architecture/5-security-rbac.md#PII Scrubbing]
- **RBAC**: Evaluate via `erp.permissions.check` before listing documents [Source: architecture/5-security-rbac.md#RBAC]

### Testing
- **Test Standards**: Follow testing strategy from architecture docs [Source: architecture/12-testing-strategy.md]
- **Test Types**: Unit tests for CRUD functions; integration tests against mock ERPNext responses
- **Test Coverage**: Cover success scenarios, filter scenarios, and empty results

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug logs required - all tasks completed successfully

### Completion Notes List
- All acceptance criteria met: supports filters + limit, empty result returns []
- Complete erp.doc.list tool implementation with comprehensive filtering and pagination
- Advanced filter translation to ERPNext query format with field filtering
- All 16 new unit tests pass covering filters, pagination, field selection, and edge cases
- Code follows project standards with proper logging and PII redaction

### File List
- src/core/crud.ts - Enhanced with listDocuments function, filters, and pagination
- src/mcp/register_tools.ts - Updated with doc.list tool registration and schema
- test/crud.test.ts - Enhanced with comprehensive listDocuments unit tests

## QA Results

### Review Date: 2025-09-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Outstanding document listing implementation with comprehensive filtering, pagination, and field selection capabilities. The code demonstrates sophisticated query parameter building, efficient filter translation to ERPNext format, and proper empty result handling.

### Refactoring Performed

No refactoring required - code quality is excellent with advanced feature implementation.

### Compliance Check

- Coding Standards: ✓ Proper TypeScript interfaces, complex query building, consistent error handling
- Project Structure: ✓ Follows established patterns with proper separation of concerns
- Testing Strategy: ✓ Comprehensive unit tests with 314 tests passing, covering all scenarios
- All ACs Met: ✓ All acceptance criteria exceeded with advanced filtering and pagination

### Improvements Checklist

- [x] Document listing with comprehensive filters and field selection
- [x] Advanced filter translation to ERPNext query format
- [x] Pagination support with configurable limits
- [x] Proper empty result handling returning empty array
- [x] All edge cases covered including invalid filters and network failures
- [ ] Consider adding sorting capabilities
- [ ] Implement cursor-based pagination for large datasets

### Security Review

Strong security implementation with authentication requirements, field-level filtering for data minimization, and proper error handling. Filter translation prevents injection attacks through proper JSON encoding.

### Performance Considerations

Performance is optimized with pagination limits and field filtering that reduces data transfer. Query parameter building is efficient and prevents unnecessary data loading.

### Files Modified During Review

None - no changes required during review.

### Gate Status

Gate: PASS → docs/qa/gates/1.4-crud-list-documents-qa-gate.yml
Risk profile: Not required - no risks identified
NFR assessment: docs/qa/assessments/1.4-crud-list-documents-nfr-20250924.md

### Recommended Status

✓ Ready for Done
