# <!-- Powered by BMAD™ Core -->

# Story 2.2: Domain Packs - Sales

## Status
Ready for Review

## Story
**As a** sales representative,
**I want** to use natural sales commands for lead and order management,
**so that** I can complete sales workflows through chat without navigating ERPNext forms.

## Acceptance Criteria
1. Lead creation works via `sales.create_lead` with contact validation
2. Lead conversion works via `sales.convert_lead_to_customer` with data mapping
3. Quotation creation works via `sales.create_quotation` with item validation
4. Sales order creation works via `sales.create_sales_order` with delivery tracking
5. Sales pipeline retrieval works via `sales.get_sales_pipeline` with status grouping

## Tasks / Subtasks
- [x] Task 1: Create Sales pack foundation (AC: 1,2,3,4,5)
  - [x] Subtask 1.1: Create src/packs/sales.ts with base structure
  - [x] Subtask 1.2: Implement createLead function with contact validation
  - [x] Subtask 1.3: Implement convertLeadToCustomer function with data mapping
  - [x] Subtask 1.4: Implement createQuotation function with item validation
  - [x] Subtask 1.5: Implement createSalesOrder function with delivery date handling
  - [x] Subtask 1.6: Implement getSalesPipeline function with status grouping
- [x] Task 2: Register Sales tools in MCP (AC: 1,2,3,4,5)
  - [x] Subtask 2.1: Add Sales tool schemas to MCP register
  - [x] Subtask 2.2: Add Sales request handlers to MCP register
  - [x] Subtask 2.3: Update total tool count in register
- [x] Task 3: Create comprehensive unit tests (AC: 1,2,3,4,5)
  - [x] Subtask 3.1: Create test/sales.test.ts with mock setup
  - [x] Subtask 3.2: Test createLead with contact validation scenarios
  - [x] Subtask 3.3: Test convertLeadToCustomer with data mapping
  - [x] Subtask 3.4: Test createQuotation with item validation
  - [x] Subtask 3.5: Test createSalesOrder with delivery validation
  - [x] Subtask 3.6: Test getSalesPipeline with status grouping

## Dev Notes

### Previous Story Insights
Story 1.13 completed Core Spine with comprehensive RBAC and safety tools. Story 2.1 will establish the domain pack pattern with HR functions. Sales pack follows the same pattern using Core Spine tools internally.

### Data Models
**Lead DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: lead_name (data), email_id (data), phone (data)
- Optional fields: company_name (data), source (link), status (select)

**Customer DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: customer_name (data), customer_type (select)
- Optional fields: customer_group (link), territory (link), default_currency (link)

**Quotation DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: party_name (link), quotation_to (select: Customer/Lead)
- Child table: items with item_code (link), qty (float), rate (currency)

**Sales Order DocType** [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- Required fields: customer (link), delivery_date (date)
- Child table: items with item_code (link), qty (float), rate (currency)

### API Specifications
All Sales pack functions call Core Spine tools internally [Source: architecture/3-tool-namespaces-schemas-mcp.md#32]:
- `sales.create_lead` → calls `erp.doc.create` with Lead doctype
- `sales.convert_lead_to_customer` → calls `erp.doc.create` with Customer doctype + `erp.doc.update` for Lead
- `sales.create_quotation` → calls `erp.doc.create` with Quotation doctype
- `sales.create_sales_order` → calls `erp.doc.create` with Sales Order doctype
- `sales.get_sales_pipeline` → calls `erp.doc.list` with Lead/Opportunity filters

### File Locations
**Based on project structure** [Source: architecture/11-developer-experience-project-layout.md]:
- Sales pack module: `src/packs/sales.ts`
- Sales unit tests: `test/sales.test.ts`
- MCP tool registration: Update `src/mcp/register_tools.ts`

### Testing Requirements
**Following testing strategy** [Source: architecture/12-testing-strategy.md]:
- Unit tests with mock ERPNext responses for lead/customer creation
- Contract tests for quotation and sales order item validation
- RBAC matrix tests for customer conversion permissions
- Input validation tests for contact information and item codes

### Technical Constraints
- All Sales functions must use existing Core Spine tools (no direct ERPNext API calls)
- Contact validation required for lead creation (email format, phone format)
- Item validation required for quotation/sales order creation
- Error mapping to canonical `{code, message, hint}` format required
- Date validation required for delivery dates

## Testing

### Testing Standards
**Test file location**: test/sales.test.ts
**Test standards**: Jest framework with mocking of erpAuthenticator and axios
**Testing frameworks**: Follow existing pattern from test/hr.test.ts and other domain packs
**Specific requirements**: Mock ERPNext responses for leads/customers/items, test validation scenarios, verify child table handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results