# <!-- Powered by BMAD™ Core -->

# Story 1.3: CRUD – Get Document

## Status
Ready for Review

## Story
**As a** user,
**I want** fetch a document by name,
**so that** I can view ERPNext data directly in chat.

## Acceptance Criteria
1. Returns requested fields
2. Missing doc → `{code: "NOT_FOUND"}`

## Tasks / Subtasks
- [x] Task 1: Implement erp.doc.get tool (AC: 1, 2)
  - [x] Subtask 1.1: Add get function to src/core/crud.ts
  - [x] Subtask 1.2: Implement get function with doctype, name, fields? parameters
  - [x] Subtask 1.3: Add document existence validation logic
  - [x] Subtask 1.4: Return requested fields for existing document
  - [x] Subtask 1.5: Return NOT_FOUND error for missing document
- [x] Task 2: Enhance ERPNext REST API integration (AC: 1, 2)
  - [x] Subtask 2.1: Add document retrieval endpoint to erpnext_client.ts
  - [x] Subtask 2.2: Handle field filtering and projection
  - [x] Subtask 2.3: Implement error mapping for missing documents
  - [x] Subtask 2.4: Add response logging with PII scrubbing
- [x] Task 3: Register doc.get tool in MCP (AC: 1, 2)
  - [x] Subtask 3.1: Update src/mcp/register_tools.ts to include doc.get tool
  - [x] Subtask 3.2: Create JSON schemas for doc.get tool inputs/outputs
  - [x] Subtask 3.3: Test tool registration and schema validation
- [x] Task 4: Add unit tests (AC: 1, 2)
  - [x] Subtask 4.1: Add tests to test/crud.test.ts
  - [x] Subtask 4.2: Write tests for successful document retrieval
  - [x] Subtask 4.3: Write tests for missing document scenarios
  - [x] Subtask 4.4: Write tests for field filtering functionality

## Dev Notes
### Relevant Source Tree Information
- **Core Module Location**: src/core/crud.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Adapter Location**: src/adapters/erpnext_client.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Tool Registration**: src/mcp/register_tools.ts [Source: architecture/11-developer-experience-project-layout.md#2.1]
- **Test Location**: test/crud.test.ts [Source: architecture/11-developer-experience-project-layout.md#12]

### Technical Implementation Details
- **Framework**: MCP SDK [Source: architecture/2-components-responsibilities.md#2.1]
- **Error Handling**: Use canonical error format `{code: "NOT_FOUND"}` [Source: architecture/4-error-model-result-envelope.md#Common codes]
- **Response Format**: Follow standard envelope with requestId, tool, ok, data, meta [Source: architecture/4-error-model-result-envelope.md#Envelope]
- **Transport**: HTTPS to ERPNext; TLS verification required [Source: architecture/5-security-rbac.md#Transport]

### Tool Specifications
- **erp.doc.get**: `{ doctype, name, fields? } → { doc }` [Source: architecture/3-tool-namespaces-schemas-mcp.md#3.1]

### Security Considerations
- **PII Scrubbing**: Logs redact tokens, salaries, card data; configurable field allow/deny lists [Source: architecture/5-security-rbac.md#PII Scrubbing]
- **RBAC**: Evaluate via `erp.permissions.check` before accessing documents [Source: architecture/5-security-rbac.md#RBAC]

### Testing
- **Test Standards**: Follow testing strategy from architecture docs [Source: architecture/12-testing-strategy.md]
- **Test Types**: Unit tests for CRUD functions; integration tests against mock ERPNext responses
- **Test Coverage**: Cover success scenarios, error scenarios, and field filtering

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-23 | v1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No debug logs required - all tasks completed successfully

### Completion Notes List
- All acceptance criteria met: returns requested fields, missing doc returns NOT_FOUND
- Complete erp.doc.get tool implementation with optional field filtering
- Comprehensive error handling for all scenarios (404, 403, network errors, empty responses)
- All 13 new unit tests pass covering success/failure/field filtering scenarios
- Code follows project standards with proper logging and PII redaction

### File List
- src/core/crud.ts - Enhanced with getDocument function and field filtering
- src/mcp/register_tools.ts - Updated with doc.get tool registration and schema
- test/crud.test.ts - Enhanced with comprehensive getDocument unit tests

## QA Results

### Review Date: 2025-09-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent document retrieval implementation with robust field filtering capabilities. The code demonstrates sophisticated error handling, proper NOT_FOUND response handling, and efficient field selection that minimizes data transfer.

### Refactoring Performed

No refactoring required - code quality is excellent with clean implementation.

### Compliance Check

- Coding Standards: ✓ Proper TypeScript interfaces, efficient field filtering, consistent error handling
- Project Structure: ✓ Follows established patterns with proper separation of concerns
- Testing Strategy: ✓ Comprehensive unit tests with 298 tests passing, covering all scenarios
- All ACs Met: ✓ All acceptance criteria fully implemented with field filtering support

### Improvements Checklist

- [x] Document retrieval with proper field filtering and validation
- [x] Comprehensive NOT_FOUND error handling for missing documents
- [x] ERPNext API integration with proper URL building for field selection
- [x] Authentication state management and permission checks
- [x] All edge cases covered including permission errors and network failures
- [ ] Consider adding response caching for frequently accessed documents
- [ ] Implement document versioning support

### Security Review

Strong security implementation with field-level access control, authentication requirements, and proper error handling that prevents information leakage. Field filtering supports data minimization principles.

### Performance Considerations

Performance is optimized with efficient field filtering that reduces data transfer. Proper timeout handling prevents hanging requests.

### Files Modified During Review

None - no changes required during review.

### Gate Status

Gate: PASS → docs/qa/gates/1.3-crud-get-document-qa-gate.yml
Risk profile: Not required - no risks identified
NFR assessment: docs/qa/assessments/1.3-crud-get-document-nfr-20250924.md

### Recommended Status

✓ Ready for Done
